-- ====== Services ======
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- ====== Lighting Effect ======
local Lighting = game.Lighting
local CC = Lighting:FindFirstChild("MainColorCorrection")
if not CC then
    CC = Instance.new("ColorCorrectionEffect")
    CC.Name = "MainColorCorrection"
    CC.Parent = Lighting
end

-- Thiết lập ban đầu
CC.TintColor = Color3.fromRGB(255, 255, 255)
CC.Contrast = 0.8
CC.Saturation = -0.9

-- Tween đồng bộ mượt
TweenService:Create(CC, TweenInfo.new(5), {Contrast = 0, Saturation = 0, TintColor = Color3.fromRGB(60, 119, 179)}):Play()

-- ====== Gradient hai bên xanh ======
local gui = Instance.new("ScreenGui")
gui.Name = "DreadClockEffect"
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(1, 0, 1, 0)
frame.BackgroundTransparency = 1
frame.Parent = gui

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(0,0,163)),  -- trái
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255,255,255)), -- giữa
    ColorSequenceKeypoint.new(1, Color3.fromRGB(0,0,163))   -- phải
}
gradient.Rotation = 0
gradient.Parent = frame

-- ====== Tạo DreadClock ======
local currentRoom = workspace.CurrentRooms[ReplicatedStorage.GameData.LatestRoom.Value]

local DreadClock = Instance.new("Model")
DreadClock.Name = "DreadClock"
DreadClock.Parent = currentRoom

local eyes = game:GetObjects("rbxassetid://15033250482")[1]

-- Xác định vị trí spawn
local num = 0
if currentRoom:FindFirstChild("PathfindNodes") then
    num = math.floor(#currentRoom.PathfindNodes:GetChildren()/2)
end

local targetCFrame = (num == 0 and currentRoom[currentRoom.Name] or currentRoom.PathfindNodes[num]).CFrame + Vector3.new(0, 5, 0)
eyes:PivotTo(targetCFrame)

eyes.Parent = DreadClock
if eyes.PrimaryPart then
    eyes.PrimaryPart.Anchored = true
end

-- ====== Hàm tải âm thanh ======
local function GitAud(soundlink, filename)
    if not isfile(filename..".mp3") then
        writefile(filename..".mp3", game:HttpGet(soundlink))
    end
    return (getcustomasset or getsynasset)(filename..".mp3")
end

-- ====== Hàm âm thanh giảm tốc độ ======
local function CustomGitSoundWithSlow(soundlink, vol, filename, totalDuration, slowInterval, slowStep)
    local DreadSound = Instance.new("Sound")
    DreadSound.SoundId = GitAud(soundlink, filename)
    DreadSound.Volume = vol
    DreadSound.Looped = true
    DreadSound.PlaybackSpeed = 1  -- tốc độ ban đầu
    DreadSound.Parent = workspace
    DreadSound:Play()

    local elapsed = 0
    while elapsed < totalDuration and DreadSound.Parent do
        wait(slowInterval)
        elapsed = elapsed + slowInterval
        if DreadSound.PlaybackSpeed - slowStep > 0 then
            DreadSound.PlaybackSpeed = DreadSound.PlaybackSpeed - slowStep
        else
            DreadSound.PlaybackSpeed = 0.1 -- tốc độ tối thiểu
        end
    end

    -- Khi xóa DreadClock, trả về tốc độ bình thường
    DreadSound:Stop()
    DreadSound.PlaybackSpeed = 1
    DreadSound:Destroy()
end

-- ====== Chạy âm thanh ======
-- totalDuration = 15 giây, mỗi 2.5 giây giảm 0.5 tốc độ
CustomGitSoundWithSlow(
    "https://github.com/Kotyara19k-Doorsspawner/Random-files/raw/main/ClockSounds.mp3",
    1, "DreadClock", 15, 2.5, 0.5
)

-- ====== Xóa DreadClock và hiệu ứng sau 1 giây ======
wait(1)
if DreadClock then
    DreadClock:Destroy()
end
if gui then
    gui:Destroy()
end

-- ====== Lighting reset ======
CC.TintColor = Color3.fromRGB(60, 119, 179)
CC.Contrast = 0.8
CC.Saturation = -0.9
TweenService:Create(CC, TweenInfo.new(5), {Contrast = 0, Saturation = 0, TintColor = Color3.fromRGB(255,255,255)}):Play()
